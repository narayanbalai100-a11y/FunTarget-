Name: Build Cordova APK

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      # рдпрд╣ рдЖрдкрдХреА рдореЗрди рд░рд┐рдкреЛрдЬрд┐рдЯрд░реА рдХреА рд╕рднреА рдлрд╛рдЗрд▓реЗрдВ рдФрд░ ZIP рдлрд╛рдЗрд▓ рд▓рд╛рддрд╛ рд╣реИред

    - name: Setup Java JDK
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: 17

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18

    - name: Install Cordova
      run: npm install -g cordova

    # ЁЯФе FIXED unzip (рдпрд╣ рдЖрдкрдХреА ZIP рдлрд╛рдЗрд▓ рдХреЗ рдЕрдВрджрд░ рдХреЗ рд╣рд░ рдлреЛрд▓реНрдбрд░ рдХреЛ рд╕реБрд░рдХреНрд╖рд┐рдд рдирд┐рдХрд╛рд▓реЗрдЧрд╛)
    - name: Unzip project (safe)
      run: |
        rm -rf cordova_project
        mkdir cordova_project
        unzip -oq FunTarget_Final_Clean.zip -d cordova_project || true
        echo "Check extracted files:"
        ls -R cordova_project 

    # ЁЯФе FIXED move (рдпрд╣ рдкрдХреНрдХрд╛ рдХрд░рддрд╛ рд╣реИ рдХрд┐ рд╕рд╣реА рдлреЛрд▓реНрдбрд░ рдорд┐рд▓реЗ)
    - name: Prepare Cordova project
      run: |
        cd cordova_project
        PROJECT_DIR=$(find . -maxdepth 2 -name config.xml | head -n 1 | xargs dirname)
        echo "Detected Cordova project at: $PROJECT_DIR"
        mv "$PROJECT_DIR" project
        ls project

    - name: Install project dependencies
      run: |
        cd cordova_project/project
        npm install
        # рдпрд╣ рдЖрдкрдХреЗ рд╕рднреА рдкреНрд▓рдЧрдЗрдиреНрд╕ рдХреЛ рдлрд┐рд░ рд╕реЗ рд▓реЛрдб рдХрд░реЗрдЧрд╛ рддрд╛рдХрд┐ рдПрдкреАрдХреЗ рдЦрд╛рд▓реА рди рд░рд╣реЗред

    - name: Add Android platform (safe)
      run: |
        cd cordova_project/project
        # рд╣рдо рдкреНрд▓реЗрдЯрдлреЙрд░реНрдо рдХреЛ рдлреНрд░реЗрд╢ рддрд░реАрдХреЗ рд╕реЗ рдЬреЛреЬреЗрдВрдЧреЗ рддрд╛рдХрд┐ рдХреЛрдИ рднреА рдлреЛрд▓реНрдбрд░ рдЕрдзреВрд░рд╛ рди рд░рд╣реЗ
        cordova platform remove android --nosave || true
        cordova platform add android

    - name: Full Asset Sync
      run: |
        cd cordova_project/project
        # рдпрд╣ рд╕реНрдЯреЗрдк рдЖрдкрдХреЗ HTML, рдЗрдореЗрдЬреЗрд╕ рдФрд░ рд╕рднреА рд╕рдм-рдлреЛрд▓реНрдбрд░реНрд╕ рдХреЛ рдПрдВрдбреНрд░реЙрдЗрдб рдПрдкреАрдХреЗ рд╕реНрдЯреНрд░рдХреНрдЪрд░ рдореЗрдВ рдбрд╛рд▓ рджреЗрдЧрд╛ред
        cordova prepare android

    - name: Build APK (Debug)
      run: |
        cd cordova_project/project
        # рдпрд╣рд╛рдБ рдЖрдкрдХрд╛ рдЕрд╕рд▓реА рдФрд░ рдкреВрд░рд╛ рдПрдкреАрдХреЗ рддреИрдпрд╛рд░ рд╣реЛрдЧрд╛ред
        cordova build android --debug

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: FunTarget-Complete-APK
        path: cordova_project/project/platforms/android/app/build/outputs/apk/debug/*.apk
        # рдЕрдм рдЖрдкрдХреЛ 'Summary' рдореЗрдВ рдПрдХ рдкреВрд░рд╛ рдбрд╛рдЙрдирд▓реЛрдб рд╣реЛрдиреЗ рд╡рд╛рд▓рд╛ рдПрдкреАрдХреЗ рдорд┐рд▓реЗрдЧрд╛ред
